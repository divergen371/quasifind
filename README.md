# Quasi-find

Quasi-find は、型付き DSL を用いてファイルシステムを検索する、OCaml 製のコマンドラインツールです。Unix の `find` コマンドの代替を目指していますが、より表現力の高いクエリ言語を提供します。

## 特長

- **型付き DSL**: `size > 10MB` や `mtime < 7d` のように、型安全な式で検索条件を記述できます。
- **高速な走査**: `Eio` を用いた並列走査により、大規模なディレクトリツリーも効率的に検索できます。
- **正規表現**: ファイル名やパスに対して PCRE 正規表現 (`=~`) を利用可能です。
- **直感的な単位**: `KB`, `MB`, `GB` や `s` (秒), `m` (分), `h` (時間), `d` (日) などの単位を直接扱えます。

## インストール

```bash
dune build
dune install
```

## 使い方

```bash
quasifind [DIR] "EXPR" [OPTIONS]
```

### 使用例 (Cookbook)

#### 基本的な検索

カレントディレクトリから、名前が `.log` で終わるファイルを検索（正規表現）:

```bash
quasifind . 'name =~ /\.log$/'
```

サイズが 10MB 以上かつ更新が 7 日以内のファイルを検索:

```bash
quasifind . 'size > 10MB && mtime < 7d'
```

#### 高度な検索

`_build` ディレクトリを除外して検索（パスに対する正規表現）:

```bash
quasifind . 'name == "main.exe" && path =~ /^(?!.*_build\/)/'
```

※ 注: 隠しファイル（`.`で始まる）はデフォルトで除外されます。`_build` は隠しファイルではないため、上記のように正規表現で弾くか、無視リスト機能で弾くようにします（将来実装予定）。

ファイルタイプを指定して検索（ディレクトリのみ）:

```bash
quasifind . 'type == dir && name =~ /^test_/'
```

#### コマンド実行

見つかった各ファイルに対して `ls -l` を実行（`{}` はパスに置換されます）:

```bash
quasifind . 'size > 1MB' -x "ls -l {}"
```

見つかった全てのログファイルをまとめて `tar` で圧縮（バッチ実行）:

```bash
quasifind . 'name =~ /\.log$/' -X "tar czf logs.tar.gz {}"
```

**注意**: `-X` オプションは、見つかったファイルを引数としてコマンドを一度だけ実行します。そのため、`{}` は全パス（スペース区切り）に置換されます。
ドライラン機能はまだ実装してないので、検索結果をよく確認してから実行オプションを使用してください。特に `rm` や `rm -rf` などの破壊的コマンドを実行する場合は、十分に注意してください。

#### オプション活用

隠しファイルも含めて検索（`--hidden` / `-H`）:

```bash
quasifind . 'name == ".gitignore"' -H
```

並列度 8 で高速に検索（`-j`）:

```bash
quasifind /data 'size > 1GB' -j 8
```

探索深さを 2 階層までに制限（`-d`）:

```bash
quasifind . 'true' -d 2
```

### オプション

- `-d DEPTH`, `--max-depth=DEPTH`: 探索する最大深度を指定します。
- `-h`: ヘルプを表示します。
- `-H`, `--hidden`: 隠しファイル・ディレクトリ（.で始まるもの）も含めて検索します（デフォルトでは除外されます）。
- `-h`: ヘルプを表示します。
- `-j JOBS`, `--jobs=JOBS`: 並列実行するジョブ数（スレッド数）を指定します。デフォルトは 1 です。
- `-L`, `--follow`: シンボリックリンクを追跡します。
- `-x CMD`, `--exec=CMD`: 各検索結果に対してコマンドを実行します。`{}` はパスに置換されます。
- `-X CMD`, `--exec-batch=CMD`: すべての検索結果を引数としてコマンドを一度だけ実行します。`{}` は全パス（スペース区切り）に置換されます。

## クエリ言語

- **フィールド**: `name`, `path`, `type`, `size`, `mtime`
- **演算子**: `==`, `!=`, `<`, `<=`, `>`, `>=`, `=~` (正規表現)
- **論理演算**: `&&` (AND), `||` (OR), `!` (NOT)
- **値**:
  - 文字列: `"sample.txt"`
  - 正規表現: `/^test_.*\.ml$/`
  - ファイルタイプ: `file`, `dir`, `symlink`
  - サイズ: `123`, `10KB`, `1.5GB`
  - 時間: `10s`, `5m`, `24h`, `7d`

### 正規表現について

`name` および `path` フィールドに対して、`=~` 演算子を用いて正規表現によるマッチングが可能です。

- **構文**: `/pattern/` の形式で記述します。中身は PCRE (Perl Compatible Regular Expressions) 互換の構文をサポートしています（OCaml `re` ライブラリを使用）。
- **フラグ**: 現在フラグ指定（`i` など）はサポートしていません。デフォルトで大文字小文字を区別します。
- **エスケープ**: スラッシュ `/` をパターンに含める場合は `\/` とエスケープしてください。

**例**:

- 拡張子が `.ml` または `.mli`: `name =~ /\.(ml|mli)$/`
- 先頭が `test_` で始まる: `name =~ /^test_/`
- 特定ディレクトリ `_build` を含まないパス: `path =~ /^(?!.*_build\/).*$/` (否定先読みなどが使えるかは `re` の PCRE サポート状況に依存しますが、基本的な互換性はあります)

## ライセンス

MIT License
