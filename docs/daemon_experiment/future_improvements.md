# Daemon Future Improvements Plan

デーモン機能の将来の拡張計画。

## 機能拡張候補

### 1. Stats コマンドの実装

`quasifind stats --daemon` で以下を表示：

- VFSノード数
- メモリ使用量
- 監視中のルートディレクトリ
- 最終更新時刻

### 2. 複数ルートディレクトリ対応

現在は `.` 固定。複数パスの監視に対応。

```bash
quasifind daemon /path/to/project1 /path/to/project2
```

### 3. Graceful Shutdown

SIGTERM/SIGINTハンドラでVFSを確実に保存。

- `at_exit`に加えてシグナルハンドラを登録
- 保存完了確認後にプロセス終了

### 4. 設定ファイル対応

`~/.config/quasifind/daemon.json`:

```json
{
  "watch_interval": 2.0,
  "cache_path": "~/.cache/quasifind/daemon.dump",
  "roots": ["."],
  "exclude": ["node_modules", "_build"]
}
```

---

## パフォーマンス

### 5. ベンチマーク追加

- デーモン vs 直接検索の速度比較測定
- README/docs にベンチマーク結果を追加
- 初回スキャン時間 vs クエリ応答時間

### 6. メモリ最適化

- 大規模ディレクトリ（100k+ファイル）でのメモリ使用量監視
- ART のノード圧縮最適化
- `Marshal` の代替検討（より効率的なシリアライズ）

---

## テスト強化

### 7. 統合テスト

エンドツーエンドテスト：

- 実際にデーモンを起動
- IPC経由でクエリを実行
- 結果を検証

### 8. 枝刈りテスト

`can_prune_path` のエッジケース：

- 空パス
- ルートディレクトリ
- 複雑なネストされたクエリ（AND/OR/NOT）
- 正規表現パターンの様々な形式

---

## エラーメッセージ改善

### 9. ユーザーフレンドリーなエラーメッセージ

全体的なエラーメッセージの改善：

- 技術的なスタックトレースをユーザー向けメッセージに変換
- 解決策や次のアクションを提案
- 一般的なエラーシナリオ:
  - ファイル/ディレクトリが存在しない
  - 権限不足
  - 構文エラー（DSL）
  - デーモン接続エラー

### 10. エラーコードの標準化

終了コードの整理:

- `0`: 成功
- `1`: 一般的なエラー
- `2`: 構文エラー（DSLパース失敗）
- `3`: 接続エラー（デーモン未起動など）

---

## エラーテスト

### 11. エラーハンドリングテスト

各モジュールのエラーケーステスト：

- Parser: 不正な構文
- Typecheck: 型不一致
- Eval: ファイルアクセスエラー
- IPC: 接続失敗、タイムアウト
- Daemon: 不正なリクエスト

### 12. エラーメッセージ検証テスト

エラーメッセージが適切で一貫性があることを検証：

- ユーザーに理解可能な言語
- 技術的詳細の非露出
- 解決策の提示

---

## 完了項目

- [x] 孤立ファイル (`send_shutdown.ml`) の削除
- [x] `quasifind daemon stop` サブコマンドの追加
- [x] `daemon stop` のエラーメッセージ改善
