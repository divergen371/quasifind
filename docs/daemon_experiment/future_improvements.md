# Daemon Future Improvements Plan

デーモン機能の将来の拡張計画。

## 機能拡張候補

### 1. Stats コマンドの実装

`quasifind stats --daemon` で以下を表示：

- VFSノード数
- メモリ使用量
- 監視中のルートディレクトリ
- 最終更新時刻

### 2. 複数ルートディレクトリ対応

現在は `.` 固定。複数パスの監視に対応。

```bash
quasifind daemon /path/to/project1 /path/to/project2
```

### 3. Graceful Shutdown

SIGTERM/SIGINTハンドラでVFSを確実に保存。

- `at_exit`に加えてシグナルハンドラを登録
- 保存完了確認後にプロセス終了

### 4. 設定ファイル対応

`~/.config/quasifind/daemon.json`:

```json
{
  "watch_interval": 2.0,
  "cache_path": "~/.cache/quasifind/daemon.dump",
  "roots": ["."],
  "exclude": ["node_modules", "_build"]
}
```

---

## パフォーマンス

### 5. ベンチマーク追加

- デーモン vs 直接検索の速度比較測定
- README/docs にベンチマーク結果を追加
- 初回スキャン時間 vs クエリ応答時間

### 6. メモリ最適化

- 大規模ディレクトリ（100k+ファイル）でのメモリ使用量監視
- ART のノード圧縮最適化
- `Marshal` の代替検討（より効率的なシリアライズ）

---

## テスト強化

### 7. 統合テスト

エンドツーエンドテスト：

- 実際にデーモンを起動
- IPC経由でクエリを実行
- 結果を検証

### 8. 枝刈りテスト

`can_prune_path` のエッジケース：

- 空パス
- ルートディレクトリ
- 複雑なネストされたクエリ（AND/OR/NOT）
- 正規表現パターンの様々な形式

---

## エラーメッセージ改善

### 9. ユーザーフレンドリーなエラーメッセージ

全体的なエラーメッセージの改善：

- 技術的なスタックトレースをユーザー向けメッセージに変換
- 解決策や次のアクションを提案
- 一般的なエラーシナリオ:
  - ファイル/ディレクトリが存在しない
  - 権限不足
  - 構文エラー（DSL）
  - デーモン接続エラー

### 10. エラーコードの標準化

終了コードの整理:

- `0`: 成功
- `1`: 一般的なエラー
- `2`: 構文エラー（DSLパース失敗）
- `3`: 接続エラー（デーモン未起動など）

---

## エラーテスト

### 11. エラーハンドリングテスト

各モジュールのエラーケーステスト：

- Parser: 不正な構文
- Typecheck: 型不一致
- Eval: ファイルアクセスエラー
- IPC: 接続失敗、タイムアウト
- Daemon: 不正なリクエスト

### 12. エラーメッセージ検証テスト

エラーメッセージが適切で一貫性があることを検証：

- ユーザーに理解可能な言語
- 技術的詳細の非露出
- 解決策の提示

---

## グローバルエラーハンドリング改善

### 13. Result型ベースのエラーハンドリング

現在は例外がそのまま伝播している。構造化されたエラー型に移行：

```ocaml
type quasifind_error =
  | ParseError of string * int * int  (* message, line, col *)
  | TypeError of string
  | FileError of string * string      (* path, reason *)
  | DaemonError of string
  | PermissionDenied of string

val run : ... -> (result, quasifind_error) result
```

### 14. 各モジュールのエラー改善

| モジュール  | 現状                     | 改善案                                  |
| ----------- | ------------------------ | --------------------------------------- |
| Parser      | exception直接            | `ParseError` + 行/列情報                |
| Typecheck   | exception直接            | `TypeError` + 詳細メッセージ            |
| Vfs/Daemon  | `Unix_error`生伝播       | `DaemonError` でラップ                  |
| Traversal   | 権限エラーでスキップ無し | `PermissionDenied` + スキップオプション |
| Content検索 | 読込失敗で crash         | fallback + warning                      |

### 15. エラー回復ストラテジー

- **権限エラー**: スキップして続行 + 警告
- **読込エラー**: ファイルをスキップ + カウンタ表示
- **デーモンエラー**: フォールバック直接検索
- **構文エラー**: 詳細な位置情報 + 修正提案

---

## テスト品質向上

### 16. Parser テストケース拡充

現状: 基本的なパース成功のみ

追加すべきケース:

- **エッジケース**: 空文字列、空白のみ、非常に長い式
- **演算子境界**: `size >= 0`, `size <= 0`, `size == -1`
- **文字列エスケープ**: `name == "file\"with\"quotes.txt"`
- **正規表現バリエーション**: `/^$/`, `/(?i)pattern/`, `/\s+/`
- **ネスト深度**: `((((true))))`
- **複合式**: 10個以上のAND/OR連鎖

### 17. Typecheck テストケース拡充

追加すべきケース:

- **型不一致**: `size == "string"`, `name > 100`
- **未知フィールド**: `unknown_field == 1`
- **暗黙変換**: `size > 1K` vs `size > "1K"`

### 18. Eval テストケース拡充

追加すべきケース:

- **境界値**: サイズ0, 負のサイズ, Int64.max_int
- **時間**: 未来のmtime, Unix epoch (0.0), 非常に古い日付
- **権限**: 0o000, 0o777, SUID/SGID
- **シンボリックリンク**: 循環リンク、壊れたリンク
- **特殊ファイル**: デバイスファイル、ソケット、FIFO

### 19. ART/VFS テストケース拡充

追加すべきケース:

- **パス**: 空パス、ルート `/`、相対 `./a/../b`
- **日本語/UTF-8**: ファイル名に絵文字、CJK文字
- **深いネスト**: 100階層以上のディレクトリ
- **大量エントリ**: 10,000ファイルの挿入/検索
- **同時操作**: 並列insert/remove（スレッドセーフ確認）

### 20. IPC テストケース拡充

追加すべきケース:

- **不正JSON**: 構文エラー、途中切断
- **巨大ペイロード**: 10MBのレスポンス
- **タイムアウト**: 応答なしサーバー
- **同時接続**: 複数クライアント

### 21. プロパティベーステスト拡張

QCheckを活用した生成テスト:

- **任意の式**: ランダム生成した式がパース→型検査→評価可能
- **JSON往復**: 任意の値がJSON化→復元で等価
- **VFS不変条件**: insert後にfind_optで必ず取得可能

---

## UX/CLI改善

### 22. インタラクティブモード

REPL風のクエリ入力:

```bash
quasifind --interactive
> name =~ /\.ml$/
Found: 42 files
> size > 1MB && mtime < 7d
Found: 3 files
> :q
```

### 23. 出力フォーマットオプション

- `--format=json`: JSON出力
- `--format=csv`: CSV出力
- `--format=table`: テーブル形式
- `--format=null`: null区切り（xargs用）

### 24. 色付き出力

- マッチ部分のハイライト
- ファイルタイプ別の色分け
- `--color=always|auto|never`

### 25. 進捗表示

大規模ディレクトリで進捗バー:

```
Scanning... [████████░░] 80% (12,345 / 15,432 files)
```

---

## セキュリティ強化

### 26. デーモンソケット権限

- ソケットファイルを0700で作成
- 他ユーザーからの接続を拒否
- オプション: `--daemon-mode=user|system`

### 27. サンドボックスオプション

- `--sandbox=/path`: 検索範囲を制限
- ルート外のシンボリックリンク追跡禁止
- `/proc`, `/sys` など特殊ファイルシステム除外

---

## 互換性

### 28. find互換モード

```bash
quasifind --find-compat -name "*.ml" -mtime -7 -size +1M
```

既存スクリプトからの移行を容易に

### 29. fd互換モード

```bash
quasifind --fd-compat -e ml -t f
```

fdユーザーの学習コスト削減

---

## 性能最適化（メモリ）

### 30. ストリーミング結果

- 全結果をメモリに保持しない
- コールバック/イテレータベースの出力
- 100万ファイルでもOOMしない

### 31. ART圧縮（Patricia Trie化）

**現状**: パスセグメント単位でノード生成

```
/src/lib/foo.ml → 3ノード (src → lib → foo.ml)
```

**推奨アプローチ: セグメント連結圧縮**
1子ノードの連鎖を1ノードにまとめる:

```ocaml
type 'a t = {
  prefix: string list;  (* 追加: 圧縮された中間セグメント *)
  value: 'a option;
  children: 'a children;
}
```

**効果**:

```
圧縮前: src → lib → internal → foo.ml  (4ノード)
圧縮後: ["src";"lib";"internal"] → foo.ml (2ノード)
```

**実装ポイント**:

- insert時: 1子→prefixに追加
- remove時: 空になった子→親のprefixに吸収
- find時: prefix全体をスキップしてから子を検索
- メモリ削減: 30-50%見込み（深いディレクトリ構造で効果大）

**注意点**:

- insert/removeが頻繁な場合、圧縮/展開オーバーヘッドあり
- 読み取り重視（デーモンVFS）に適している

### 32. インターンプール上限

- LRUキャッシュで古い文字列を解放
- メモリリーク防止
- 設定可能な上限サイズ

---

## 性能最適化（CPU）

### 33. JIT正規表現コンパイル

- 頻出パターンをキャッシュ
- `Re.compile`のオーバーヘッド削減
- ハッシュテーブルで管理

### 34. Early Exit最適化

- `False`式で即座に終了
- `And(False, _)` → 右辺評価スキップ
- `Or(True, _)` → 右辺評価スキップ

### 35. SIMD content search

- AVX2/NEONでのパターンマッチ
- memchrの高速化
- 固定文字列検索で100x高速化の可能性

---

## 性能最適化（I/O）

### 36. バッファプール

- `mmap`リージョンの再利用
- システムコール削減
- ファイル読み込みの効率化

### 37. inotify/FSEvents対応

- ポーリングからイベント駆動へ
- CPU使用率大幅削減
- リアルタイム更新

---

## コード品質・保守性

### 38. インターフェースファイル (.mli) の導入

現状、多くのモジュールで実装（.ml）のみが存在し、内部構造がすべて公開されている。

**導入によるメリット（何が嬉しいか）**:

- **カプセル化 (内部構造の隠蔽)**: 内部実装（Trieの形状やヘルパー関数）を隠蔽でき、外部コードに影響を与えずに実装の改善・置換が可能。
- **ビルドの効率化**: 実装（.ml）のみを変更した場合、インターフェース（.mli）が変わらなければ、そのモジュールに依存する他のモジュールの再コンパイルが不要になる。
- **仕様の明確化**: ファイルを開いた瞬間に「何ができるモジュールか」が型として定義されているため、実装コードを読み解く負担が減り、ドキュメントとして機能する。
- **設計品質の向上**: 外部に何を公開し、何を隠すべきかを意識することで、疎結合でクリーンな設計が強制される。

**優先導入対象**:

1. `Art` / `Vfs`: 複雑なデータ構造の隠蔽。
2. `Ipc`: 通信プロトコルの詳細隠蔽。
3. `Eval`: 評価ロジックと型の明確化。

---

## 完了項目

- [x] 孤立ファイル (`send_shutdown.ml`) の削除
- [x] `quasifind daemon stop` サブコマンドの追加
- [x] `daemon stop` のエラーメッセージ改善
- [x] VFS重複保存問題の修正
